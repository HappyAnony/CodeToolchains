

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>常用函数 &mdash; CodeToolchains 1.0.0 文档</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="../../../../genindex.html"/>
        <link rel="search" title="搜索" href="../../../../search.html"/>
    <link rel="top" title="CodeToolchains 1.0.0 文档" href="../../../../index.html"/>
        <link rel="up" title="常用类库" href="../index.html"/>
        <link rel="next" title="脚本示例" href="../../3-sample/index.html"/>
        <link rel="prev" title="常用命令" href="../1-commoncmd/index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> CodeToolchains
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../1-TextEdit/index.html">文本编辑器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../2-VerControl/index.html">版本控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../3-IDE/index.html">IDE集成开发环境</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Linux工具集</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../1-shellenv/index.html">shell环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../2-shellcmd/index.html">shell命令</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">shell编程</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../1-syntax/index.html">语法基础</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">常用类库</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../0-commonvar/index.html">常用环境变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="../1-commoncmd/index.html">常用命令</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">常用函数</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../3-sample/index.html">脚本示例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../5-Wildcard/index.html">通配机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../6-DataBase/index.html">数据库</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../7-WebArch/index.html">网站架构</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">CodeToolchains</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Linux工具集</a> &raquo;</li>
        
          <li><a href="../../index.html">shell编程</a> &raquo;</li>
        
          <li><a href="../index.html">常用类库</a> &raquo;</li>
        
      <li>常用函数</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/4-Linux/3-shellprogram/2-library/2-commonfunc/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>常用函数<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>参考文档：<a class="reference external" href="http://www.cnblogs.com/f-ck-need-u/p/7518142.html#9-">functions文件详细分析和说明</a></p>
<p>shell中函数和命令不一样，它没有对应的二进制文件，只有相关的声明定义</p>
<p>shell中函数可以大致分为两大类：<code class="docutils literal"><span class="pre">自定义函数</span></code>和<code class="docutils literal"><span class="pre">库函数</span></code></p>
<p><code class="docutils literal"><span class="pre">自定义函数</span></code>好说，直接在脚本中自行声明定义和调用即可；在这里我们主要是介绍<code class="docutils literal"><span class="pre">库函数</span></code>，shell中所谓<code class="docutils literal"><span class="pre">库函数</span></code>就是<code class="docutils literal"><span class="pre">/etc/rc.d/init.d/functions</span></code>文件中定义的系统函数，这些系统函数几乎被<code class="docutils literal"><span class="pre">/etc/rc.d/init.d/</span></code>下所有的sysv服务启动脚本加载，在该文件中提供了以下几个非常有用的函数</p>
<ul>
<li><p class="first"><a class="reference external" href="#displaylf">显示函数</a></p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="#successl">success</a>：显示绿色的<code class="docutils literal"><span class="pre">OK</span></code>，表示成功</li>
<li><a class="reference external" href="#failurel">failure</a>：显示红色的<code class="docutils literal"><span class="pre">FAILED</span></code>，表示失败</li>
<li><a class="reference external" href="#passedl">passed</a>：显示黄色的<code class="docutils literal"><span class="pre">PASSED</span></code>，表示pass该任务</li>
<li><a class="reference external" href="#warningl">warning</a>：显示黄色的<code class="docutils literal"><span class="pre">warning</span></code>，表示警告</li>
<li><a class="reference external" href="#confirml">confirm</a>：提示<code class="docutils literal"><span class="pre">(Y)es/(N)o/(C)ontinue?</span> <span class="pre">[Y]</span></code>并判断、传递输入的值</li>
<li><a class="reference external" href="#truel">is_true</a>：<code class="docutils literal"><span class="pre">$1</span></code>的布尔值代表为真时，返回状态码<code class="docutils literal"><span class="pre">0</span></code>，否则返回<code class="docutils literal"><span class="pre">1</span></code>；包括<code class="docutils literal"><span class="pre">t/y/yes/true</span></code>，不区分大小写</li>
<li><a class="reference external" href="#falsel">is_false</a>：<code class="docutils literal"><span class="pre">$1</span></code>的布尔值代表为假时，返回状态码<code class="docutils literal"><span class="pre">0</span></code>，否则返回<code class="docutils literal"><span class="pre">1</span></code>；包括<code class="docutils literal"><span class="pre">f/n/no/false</span></code>，不区分大小写</li>
<li><a class="reference external" href="#actionl">action</a>：根据进程退出状态码自行判断是执行<code class="docutils literal"><span class="pre">success</span></code>还是<code class="docutils literal"><span class="pre">failure</span></code></li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><a class="reference external" href="#processlf">进程函数</a></p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="#checkpidl">checkpid</a>：检查<code class="docutils literal"><span class="pre">/proc</span></code>下是否有给定<code class="docutils literal"><span class="pre">pid</span></code>对应的目录，给定多个<code class="docutils literal"><span class="pre">pid</span></code>时，只要存在一个目录都返回状态码<code class="docutils literal"><span class="pre">0</span></code></li>
<li><a class="reference external" href="#runl">__pids_var_run</a>：检查<code class="docutils literal"><span class="pre">pid</span></code>是否存在，并保存到变量<code class="docutils literal"><span class="pre">pid</span></code>中，同时返回几种进程状态码</li>
<li><a class="reference external" href="#pidl">__pids_pidof</a>：获取进程<code class="docutils literal"><span class="pre">pid</span></code></li>
<li><a class="reference external" href="#pidproc">pidfileofproc</a>：获取进程<code class="docutils literal"><span class="pre">pid</span></code>，但只能获取<code class="docutils literal"><span class="pre">/var/run</span></code>下的<code class="docutils literal"><span class="pre">pid</span></code>文件中的值</li>
<li><a class="reference external" href="#pidprocll">pidofproc</a>：获取进程<code class="docutils literal"><span class="pre">pid</span></code>，可获取任意给定<code class="docutils literal"><span class="pre">pidfile</span></code>或默认<code class="docutils literal"><span class="pre">/var/run</span></code>下<code class="docutils literal"><span class="pre">pidfile</span></code>中的值</li>
<li><a class="reference external" href="#statusl">status</a>：检查给定进程的运行状态</li>
<li><a class="reference external" href="#daemonl">daemon</a>：启动一个服务程序，启动前还检查进程是否已在运行</li>
<li><a class="reference external" href="#killprocl">killproc</a>：杀掉给定的服务进程</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>以下是<code class="docutils literal"><span class="pre">/etc/init.d/functions</span></code>文件的开头定义的语句(本文分析的<code class="docutils literal"><span class="pre">/etc/init.d/functions</span></code>文件是<code class="docutils literal"><span class="pre">CentOS</span> <span class="pre">7</span></code>上的，和<code class="docutils literal"><span class="pre">CentOS</span> <span class="pre">6</span></code>有些许区别)</p>
<ul class="simple">
<li>设置<code class="docutils literal"><span class="pre">umask</span></code>值，使得加载该文件的脚本所在shell的umask为22</li>
<li>导出<code class="docutils literal"><span class="pre">PATH</span></code>路径变量，但这个导出的路径变量并不理想，因为要为<code class="docutils literal"><span class="pre">非rpm包</span></code>安装的程序设计服务启动脚本时，必须写全路径命令，例如<code class="docutils literal"><span class="pre">/usr/local/mysql/bin/mysql</span></code>，因此，可以考虑将<code class="docutils literal"><span class="pre">/etc/init.d/functions</span></code>中的该语句注释掉</li>
</ul>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Make sure umask is sane</span>
<span class="nb">umask</span> <span class="m">022</span>

<span class="c1"># Set up a default search path.</span>
<span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/sbin:/usr/sbin:/bin:/usr/bin&quot;</span>
<span class="nb">export</span> PATH
</pre></div>
</div>
<div class="section" id="x00">
<span id="displaylf"></span><h2>0x00 显示函数<a class="headerlink" href="#x00" title="永久链接至标题">¶</a></h2>
<p>显示函数常用在编写系统服务启动脚本，便于提示相关启动信息</p>
</div>
<div class="section" id="x0000-success">
<span id="successl"></span><h2>0x0000 success<a class="headerlink" href="#x0000-success" title="永久链接至标题">¶</a></h2>
<p>除了<code class="docutils literal"><span class="pre">success</span></code>函数，还有<code class="docutils literal"><span class="pre">echo_success</span></code>函数也可以显示绿色的<code class="docutils literal"><span class="pre">OK</span></code>，表示成功</p>
<p>以下是<code class="docutils literal"><span class="pre">echo_success</span></code>和<code class="docutils literal"><span class="pre">success</span></code>函数的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>echo_success<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$MOVE_TO_COL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;[&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_SUCCESS</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;  OK  &quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_NORMAL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;]&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;\r&quot;</span>
    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>


success<span class="o">()</span> <span class="o">{</span>
        <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> echo_success
        <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>
</pre></div>
</div>
<p>这两个函数的功能就是：不换行带绿色输出<code class="docutils literal"><span class="pre">[OK]</span></code>字样；效果如下</p>
<div class="figure">
<img alt="../../../../_images/19.png" src="../../../../_images/19.png" />
</div>
</div>
<div class="section" id="x0001-failure">
<span id="failurel"></span><h2>0x0001 failure<a class="headerlink" href="#x0001-failure" title="永久链接至标题">¶</a></h2>
<p>除了<code class="docutils literal"><span class="pre">failure</span></code>函数，还有<code class="docutils literal"><span class="pre">echo_failure</span></code>函数也可以显示红色的<code class="docutils literal"><span class="pre">FAILED</span></code>，表示失败</p>
<p>以下是<code class="docutils literal"><span class="pre">echo_failure</span></code>和<code class="docutils literal"><span class="pre">failure</span></code>函数的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>echo_failure<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$MOVE_TO_COL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;[&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_FAILURE</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;FAILED&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_NORMAL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;]&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;\r&quot;</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>


failure<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">rc</span><span class="o">=</span><span class="nv">$?</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> echo_failure
    <span class="o">[</span> -x /bin/plymouth <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/plymouth --details
    <span class="k">return</span> <span class="nv">$rc</span>
<span class="o">}</span>
</pre></div>
</div>
<p>这两个函数的功能就是：不换行带红色输出<code class="docutils literal"><span class="pre">[FAILED]</span></code>字样；效果如下</p>
<div class="figure">
<img alt="../../../../_images/25.png" src="../../../../_images/25.png" />
</div>
</div>
<div class="section" id="x0002-passed">
<span id="passedl"></span><h2>0x0002 passed<a class="headerlink" href="#x0002-passed" title="永久链接至标题">¶</a></h2>
<p>除了<code class="docutils literal"><span class="pre">passed</span></code>函数，还有<code class="docutils literal"><span class="pre">echo_passed</span></code>函数也可以显示黄色的<code class="docutils literal"><span class="pre">PASSED</span></code>，表示pass该任务</p>
<p>以下是<code class="docutils literal"><span class="pre">echo_passed</span></code>和<code class="docutils literal"><span class="pre">passed</span></code>函数的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>echo_passed<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$MOVE_TO_COL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;[&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_WARNING</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;PASSED&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_NORMAL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;]&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;\r&quot;</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>


passed<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">rc</span><span class="o">=</span><span class="nv">$?</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> echo_passed
    <span class="k">return</span> <span class="nv">$rc</span>
<span class="o">}</span>
</pre></div>
</div>
<p>这两个函数的功能就是：不换行带黄色输出<code class="docutils literal"><span class="pre">[PASSED]</span></code>字样；效果如下</p>
<div class="figure">
<img alt="../../../../_images/34.png" src="../../../../_images/34.png" />
</div>
</div>
<div class="section" id="x0003-warning">
<span id="warningl"></span><h2>0x0003 warning<a class="headerlink" href="#x0003-warning" title="永久链接至标题">¶</a></h2>
<p>除了<code class="docutils literal"><span class="pre">warning</span></code>函数，还有<code class="docutils literal"><span class="pre">echo_warning</span></code>函数也可以显示黄色的<code class="docutils literal"><span class="pre">warning</span></code>，表示警告</p>
<p>以下是<code class="docutils literal"><span class="pre">echo_warning</span></code>和<code class="docutils literal"><span class="pre">warning</span></code>函数的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>echo_warning<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$MOVE_TO_COL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;[&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_WARNING</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;WARNING&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;color&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$SETCOLOR_NORMAL</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;]&quot;</span>
    <span class="nb">echo</span> -ne <span class="s2">&quot;\r&quot;</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>


warning<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">rc</span><span class="o">=</span><span class="nv">$?</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> echo_warning
    <span class="k">return</span> <span class="nv">$rc</span>
<span class="o">}</span>
</pre></div>
</div>
<p>这两个函数的功能就是：不换行带黄色输出<code class="docutils literal"><span class="pre">[WARNING]</span></code>字样；效果如下</p>
<div class="figure">
<img alt="../../../../_images/43.png" src="../../../../_images/43.png" />
</div>
</div>
<div class="section" id="x0004-confirm">
<span id="confirml"></span><h2>0x0004 confirm<a class="headerlink" href="#x0004-confirm" title="永久链接至标题">¶</a></h2>
<p>这个函数一般用不上，因为脚本本来就是为了避免交互式的。在<code class="docutils literal"><span class="pre">CentOS</span> <span class="pre">7</span></code>的<code class="docutils literal"><span class="pre">functions</span></code>中已经删除了该函数定义语句。不过，借鉴下它的处理方法还是不错的</p>
<p>以下摘自<code class="docutils literal"><span class="pre">CentOS</span> <span class="pre">6.6</span></code>的<code class="docutils literal"><span class="pre">/etc/init.d/functions</span></code>文件</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># returns OK if $1 contains $2</span>
strstr<span class="o">()</span> <span class="o">{</span>
        <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">#*</span><span class="nv">$2</span><span class="p">*</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">1</span>   <span class="c1"># 参数$1中不包含$2时，返回1，否则返回0</span>
        <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

<span class="c1"># Confirm whether we really want to run this service</span>
confirm<span class="o">()</span> <span class="o">{</span>
        <span class="o">[</span> -x /bin/plymouth <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/plymouth --hide-splash
        <span class="k">while</span> : <span class="p">;</span> <span class="k">do</span>
                <span class="nb">echo</span> -n $<span class="s2">&quot;Start service </span><span class="nv">$1</span><span class="s2"> (Y)es/(N)o/(C)ontinue? [Y] &quot;</span>
                <span class="nb">read</span> answer
                <span class="k">if</span> strstr <span class="s2">$&quot;yY&quot;</span> <span class="s2">&quot;</span><span class="nv">$answer</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$answer</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
                <span class="k">return</span> <span class="m">0</span>
        <span class="k">elif</span> strstr <span class="s2">$&quot;cC&quot;</span> <span class="s2">&quot;</span><span class="nv">$answer</span><span class="s2">&quot;</span> <span class="p">;</span> <span class="k">then</span>
                rm -f /var/run/confirm
                <span class="o">[</span> -x /bin/plymouth <span class="o">]</span> <span class="o">&amp;&amp;</span> /bin/plymouth --show-splash
                <span class="k">return</span> <span class="m">2</span>
        <span class="k">elif</span> strstr <span class="s2">$&quot;nN&quot;</span> <span class="s2">&quot;</span><span class="nv">$answer</span><span class="s2">&quot;</span> <span class="p">;</span> <span class="k">then</span>
                <span class="k">return</span> <span class="m">1</span>
        <span class="k">fi</span>
        <span class="k">done</span>
<span class="o">}</span>
</pre></div>
</div>
<p>上述代码中</p>
<ul class="simple">
<li>第一个函数<code class="docutils literal"><span class="pre">strstr</span></code>的作用是判断第一个参数<code class="docutils literal"><span class="pre">$1</span></code>中是否包含了<code class="docutils literal"><span class="pre">$2</span></code>，如果包含了则返回状态码<code class="docutils literal"><span class="pre">0</span></code>,，这函数也是一个不错的技巧</li>
<li>第二个函数<code class="docutils literal"><span class="pre">confirm</span></code>的作用是根据交互式输入的值返回不同的状态码，如果输入的是<code class="docutils literal"><span class="pre">y</span></code>或<code class="docutils literal"><span class="pre">Y</span></code>或不输入时，返回<code class="docutils literal"><span class="pre">0</span></code>。输入的是<code class="docutils literal"><span class="pre">c</span></code>或<code class="docutils literal"><span class="pre">C</span></code>时，返回状态码<code class="docutils literal"><span class="pre">2</span></code>，输入的是<code class="docutils literal"><span class="pre">n</span></code>或``N``时返回状态码<code class="docutils literal"><span class="pre">1</span></code></li>
</ul>
<p>于是可以根据<code class="docutils literal"><span class="pre">confirm</span></code>的状态值决定是否要继续执行某个程序，用法和效果如下</p>
<div class="figure">
<img alt="../../../../_images/53.png" src="../../../../_images/53.png" />
</div>
</div>
<div class="section" id="x0005-is-true">
<span id="truel"></span><h2>0x0005 is_true<a class="headerlink" href="#x0005-is-true" title="永久链接至标题">¶</a></h2>
<p>以下是<code class="docutils literal"><span class="pre">is_true</span></code>函数的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Evaluate shvar-style booleans</span>
is_true<span class="o">()</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> in
    <span class="o">[</span>tT<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>yY<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>yY<span class="o">][</span>eE<span class="o">][</span>sS<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>oO<span class="o">][</span>nN<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>tT<span class="o">][</span>rR<span class="o">][</span>uU<span class="o">][</span>eE<span class="o">]</span> <span class="p">|</span> <span class="m">1</span><span class="o">)</span>
        <span class="k">return</span> <span class="m">0</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
<p>由以上代码可知：这个函数的作用就是转换输入的布尔值为状态码；<code class="docutils literal"><span class="pre">$1</span></code>第一个函数参数的布尔值代表为真(包括<code class="docutils literal"><span class="pre">t/y/yes/true</span></code>，不区分大小写)时，返回状态码<code class="docutils literal"><span class="pre">0</span></code>，否则返回<code class="docutils literal"><span class="pre">1</span></code></p>
<div class="figure">
<img alt="../../../../_images/63.png" src="../../../../_images/63.png" />
</div>
</div>
<div class="section" id="x0006-is-false">
<span id="falsel"></span><h2>0x0006 is_false<a class="headerlink" href="#x0006-is-false" title="永久链接至标题">¶</a></h2>
<p>以下是<code class="docutils literal"><span class="pre">is_false</span></code>函数的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Evaluate shvar-style booleans</span>
is_false<span class="o">()</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> in
    <span class="o">[</span>fF<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>nN<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>nN<span class="o">][</span>oO<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>oO<span class="o">][</span>fF<span class="o">][</span>fF<span class="o">]</span> <span class="p">|</span> <span class="o">[</span>fF<span class="o">][</span>aA<span class="o">][</span>lL<span class="o">][</span>sS<span class="o">][</span>eE<span class="o">]</span> <span class="p">|</span> <span class="m">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="m">0</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
<p>由以上代码可知：这个函数的作用就是转换输入的布尔值为状态码；<code class="docutils literal"><span class="pre">$1</span></code>第一个函数参数的布尔值代表为假(包括<code class="docutils literal"><span class="pre">f/n/no/false</span></code>，不区分大小写)时，返回状态码<code class="docutils literal"><span class="pre">0</span></code>，否则返回<code class="docutils literal"><span class="pre">1</span></code></p>
<div class="figure">
<img alt="../../../../_images/73.png" src="../../../../_images/73.png" />
</div>
</div>
<div class="section" id="x0007-action">
<span id="actionl"></span><h2>0x0007 action<a class="headerlink" href="#x0007-action" title="永久链接至标题">¶</a></h2>
<p>该函数在写脚本时还比较有用，可以根据退出状态码自动判断是执行<code class="docutils literal"><span class="pre">success</span></code>还是执行<code class="docutils literal"><span class="pre">failure</span></code>函数</p>
<p>以下是<code class="docutils literal"><span class="pre">action</span></code>函数的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Run some action. Log its output.</span>
action<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> STRING rc

    <span class="nv">STRING</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$STRING</span><span class="s2"> &quot;</span>
    <span class="nb">shift</span>
    <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$STRING</span><span class="s2">&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$STRING</span><span class="s2">&quot;</span>
    <span class="nv">rc</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">echo</span>
    <span class="k">return</span> <span class="nv">$rc</span>
<span class="o">}</span>
</pre></div>
</div>
<p>这个函数定义的很有技巧</p>
<ul class="simple">
<li>先将第一个参数保存并踢掉，再执行后面的命令(<code class="docutils literal"><span class="pre">&quot;$&#64;&quot;</span></code>表示执行后面的命令)</li>
<li>当<code class="docutils literal"><span class="pre">action</span></code>函数只有一个参数时，<code class="docutils literal"><span class="pre">action</span></code>直接返回<code class="docutils literal"><span class="pre">OK</span></code>，状态码为<code class="docutils literal"><span class="pre">0</span></code>；当超过一个参数时，第一个参数先被打印，再执行从第二个参数开始的命令</li>
</ul>
<p>在脚本中使用<code class="docutils literal"><span class="pre">action</span></code>函数时，可以让命令执行成功与否的判断显得更专业，效果如下</p>
<div class="figure">
<img alt="../../../../_images/83.png" src="../../../../_images/83.png" />
</div>
<p>通常，该函数会结合<code class="docutils literal"><span class="pre">/bin/true</span></code>和<code class="docutils literal"><span class="pre">/bin/false</span></code>命令使用，它们无条件返回<code class="docutils literal"><span class="pre">0</span></code>或<code class="docutils literal"><span class="pre">1</span></code>状态码；例如，<code class="docutils literal"><span class="pre">mysqld</span></code>启动脚本中，判断<code class="docutils literal"><span class="pre">mysqld</span></code>已在运行时，直接输出启动ok的消息，但实际上根本没做任何事</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># action函数使用格式</span>
<span class="c1"># action $&quot;MESSAGES: &quot; /bin/true</span>
<span class="c1"># action $&quot;MESSAGES: &quot; /bin/false</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$MYSQLDRUNNING</span> <span class="o">=</span> <span class="m">1</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$?</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c1"># already running, do nothing</span>
        action $<span class="s2">&quot;Starting </span><span class="nv">$prog</span><span class="s2">: &quot;</span> /bin/true
        <span class="nv">ret</span><span class="o">=</span><span class="m">0</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="x01">
<span id="processlf"></span><h2>0x01 进程函数<a class="headerlink" href="#x01" title="永久链接至标题">¶</a></h2>
<p>启动进程时，<code class="docutils literal"><span class="pre">pid文件</span></code>非常重要</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">pid文件</span></code>不仅可以用来判断进程是否在运行，还可以从中读取<code class="docutils literal"><span class="pre">pid号</span></code>用来杀进程</li>
<li><code class="docutils literal"><span class="pre">pid文件</span></code>中可能有多行，表示多实例</li>
</ul>
</div>
<div class="section" id="x0100-checkpid">
<span id="checkpidl"></span><h2>0x0100 checkpid<a class="headerlink" href="#x0100-checkpid" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">checkpid</span></code>函数是用来检测给定的<code class="docutils literal"><span class="pre">`pid值</span></code>在<code class="docutils literal"><span class="pre">/proc</span></code>下是否有对应的目录存在</p>
<p>以下是函数<code class="docutils literal"><span class="pre">checkpid</span></code>的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Check if any of $pid (could be plural) are running</span>
checkpid<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> i

    <span class="k">for</span> i in <span class="nv">$*</span> <span class="p">;</span> <span class="k">do</span>      <span class="c1"># 检测/proc目录下是否存在给定的进程目录</span>
        <span class="o">[</span> -d <span class="s2">&quot;/proc/</span><span class="nv">$i</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">0</span>
    <span class="k">done</span>
    <span class="k">return</span> <span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
<p>每个进程都必有一个<code class="docutils literal"><span class="pre">pid</span></code>，但并不一定都记录在<code class="docutils literal"><span class="pre">pid文件</span></code>中，例如线程的<code class="docutils literal"><span class="pre">pid</span></code>；但无论如何，在<code class="docutils literal"><span class="pre">/proc/</span></code>目录下，一定会有<code class="docutils literal"><span class="pre">pid号</span></code>命名的目录，只要有对应<code class="docutils literal"><span class="pre">pid号</span></code>的目录，就表示该进程已经在运行</p>
<p>在检查<code class="docutils literal"><span class="pre">/proc</span></code>下是否有给定<code class="docutils literal"><span class="pre">pid</span></code>对应的目录，无论给定多少个<code class="docutils literal"><span class="pre">pid</span></code>，只要有一个有目录，都返回<code class="docutils literal"><span class="pre">0</span></code></p>
<p>该函数的调用方法如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>checkpid pid_list
</pre></div>
</div>
<p>效果图如下</p>
<div class="figure">
<img alt="../../../../_images/101.png" src="../../../../_images/101.png" />
</div>
</div>
<div class="section" id="x0101-pids-var-run">
<span id="runl"></span><h2>0x0101 __pids_var_run<a class="headerlink" href="#x0101-pids-var-run" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">__pids_var_run</span></code>函数是用来判断给定程序的运行状态以及对应的pid文件是否存在</p>
<p>以下是函数<code class="docutils literal"><span class="pre">__pids_var_run</span></code>的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># __proc_pids {program} [pidfile]</span>
<span class="c1"># Set $pid to pids from /var/run* for {program}.  $pid should be declared</span>
<span class="c1"># local in the caller.</span>
<span class="c1"># Returns LSB exit code for the &#39;status&#39; action</span>

<span class="c1"># 通过检测pid判断程序是否已在运行</span>
__pids_var_run<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>                       <span class="c1"># 获取进程名的basename</span>
    <span class="nb">local</span> <span class="nv">pid_file</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="p">/var/run/</span><span class="nv">$base</span><span class="p">.pid</span><span class="si">}</span>   <span class="c1"># 定义pid文件路径</span>
    <span class="nb">local</span> <span class="nv">pid_dir</span><span class="o">=</span><span class="k">$(</span>/usr/bin/dirname <span class="nv">$pid_file</span> &gt; /dev/null<span class="k">)</span>
    <span class="nb">local</span> <span class="nv">binary</span><span class="o">=</span><span class="nv">$3</span>

    <span class="o">[</span> -d <span class="s2">&quot;</span><span class="nv">$pid_dir</span><span class="s2">&quot;</span> -a ! -r <span class="s2">&quot;</span><span class="nv">$pid_dir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">4</span>

    <span class="nv">pid</span><span class="o">=</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>   <span class="c1"># 判断给定的pid文件是否存在</span>
            <span class="nb">local</span> line p

        <span class="o">[</span> ! -r <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="m">4</span> <span class="c1"># &quot;user had insufficient privilege&quot;</span>
        <span class="k">while</span> : <span class="p">;</span> <span class="k">do</span>                     <span class="c1"># 将pid文件中的pid值赋值给pid变量</span>
            <span class="nb">read</span> line
            <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
            <span class="k">for</span> p in <span class="nv">$line</span> <span class="p">;</span> <span class="k">do</span>
                <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">p</span><span class="p">//[0-9]/</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -d <span class="s2">&quot;/proc/</span><span class="nv">$p</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
                    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$binary</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
                        <span class="nb">local</span> <span class="nv">b</span><span class="o">=</span><span class="k">$(</span>readlink /proc/<span class="nv">$p</span>/exe <span class="p">|</span> sed -e <span class="s1">&#39;s/\s*(deleted)$//&#39;</span><span class="k">)</span>
                        <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$b</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$binary</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
                    <span class="k">fi</span>
                    <span class="nv">pid</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2"> </span><span class="nv">$p</span><span class="s2">&quot;</span>
                <span class="k">fi</span>
            <span class="k">done</span>
        <span class="k">done</span> &lt; <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="c1"># pid存在，则返回0，否则表示pid文件存在，但/proc下没有对应命令</span>
                    <span class="k">return</span> <span class="m">0</span>       <span class="c1"># 即进程已死，但pid文件却存在，返回状态码1</span>
            <span class="k">fi</span>
        <span class="k">return</span> <span class="m">1</span> <span class="c1"># &quot;Program is dead and /var/run pid file exists&quot;</span>
    <span class="k">fi</span>
    <span class="k">return</span> <span class="m">3</span> <span class="c1"># &quot;Program is not running&quot;pid文件不存在时，表示进程未进行，返回状态码3</span>
<span class="o">}</span>
</pre></div>
</div>
<p>由函数定义可知：只有当<code class="docutils literal"><span class="pre">pid文件</span></code>存在，且<code class="docutils literal"><span class="pre">/proc</span></code>下有<code class="docutils literal"><span class="pre">pid</span></code>对应的目录时，才表示进程在运行(当然线程没有<code class="docutils literal"><span class="pre">pid文件</span></code>)，该函数的调用方法是：<code class="docutils literal"><span class="pre">__pids_var_run</span> <span class="pre">program</span> <span class="pre">[pidfile]</span></code></p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">program</span></code>为程序进程名</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">pidfile</span></code>为进程pid文件名，如果不给定<code class="docutils literal"><span class="pre">pidfile</span></code>，则默认为<code class="docutils literal"><span class="pre">/var/run/$base.pid</span></code>文件</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">pidfile</span></code>的路径可能为<code class="docutils literal"><span class="pre">/var/run/$base.pid</span></code>文件(<code class="docutils literal"><span class="pre">$base</span></code>表示进程名的<code class="docutils literal"><span class="pre">basename</span></code>)，此路径为默认值</li>
<li><code class="docutils literal"><span class="pre">pidfile</span></code>的路径也可能是自定义的路径，例如<code class="docutils literal"><span class="pre">mysql</span></code>的<code class="docutils literal"><span class="pre">pid</span></code>可以自定义为<code class="docutils literal"><span class="pre">/mysql/data/mysql01.pid</span></code></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">函数的执行结果有4种状态返回码</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>：表示<code class="docutils literal"><span class="pre">program</span></code>正在运行</li>
<li><code class="docutils literal"><span class="pre">1</span></code>：表示<code class="docutils literal"><span class="pre">program</span></code>进程已死，<code class="docutils literal"><span class="pre">pid文件</span></code>存在，但<code class="docutils literal"><span class="pre">/proc</span></code>目录下没有对应的文件</li>
<li><code class="docutils literal"><span class="pre">3</span></code>：表示pid文件不存在</li>
<li><code class="docutils literal"><span class="pre">4</span></code>：表示pid文件的权限错误，不可读</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">函数还会保存变量pid的结果，以供其他程序引用</p>
</li>
</ul>
<p>这个函数非常重要，不仅可以从<code class="docutils literal"><span class="pre">pidfile</span></code>中获取并保存<code class="docutils literal"><span class="pre">pid</span></code>号码，还根据情况返回几种状态码，这几个状态码是<code class="docutils literal"><span class="pre">status</span></code>函数的重要依据，在<code class="docutils literal"><span class="pre">SysV</span></code>服务启动脚本中使用非常广泛</p>
<p>该函数的调用方法如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>__pids_var_run program <span class="o">[</span>pidfile<span class="o">]</span>
</pre></div>
</div>
<p>以下是<code class="docutils literal"><span class="pre">httpd</span></code>进程的测试结果，分别是<code class="docutils literal"><span class="pre">指定pid文件</span></code>和<code class="docutils literal"><span class="pre">不指定pid文件</span></code>的情况</p>
<div class="figure">
<img alt="../../../../_images/112.png" src="../../../../_images/112.png" />
</div>
</div>
<div class="section" id="x0102-pids-pidof">
<span id="pidl"></span><h2>0x0102 __pids_pidof<a class="headerlink" href="#x0102-pids-pidof" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">__pids_pidof</span></code>函数是用来获取给定进程的<code class="docutils literal"><span class="pre">pid</span></code></p>
<p>以下是函数<code class="docutils literal"><span class="pre">__pids_pidof</span></code>的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># Output PIDs of matching processes, found using pidof</span>
<span class="c1"># 忽略当前shell的PID，父shell的PID，调用pidof程序shell的PID</span>
__pids_pidof<span class="o">()</span> <span class="o">{</span>
    pidof -c -m -o <span class="nv">$$</span> -o <span class="nv">$PPID</span> -o %PPID -x <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="se">\</span>
        pidof -c -m -o <span class="nv">$$</span> -o <span class="nv">$PPID</span> -o %PPID -x <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>由以上代码可知：该函数使用了<code class="docutils literal"><span class="pre">pidof</span></code>命令，获取给定进程的<code class="docutils literal"><span class="pre">pid</span></code>值会更加精确，其中使用了几个<code class="docutils literal"><span class="pre">-o</span></code>选项，它用于忽略指定的<code class="docutils literal"><span class="pre">pid</span></code></p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">-o</span> <span class="pre">$$</span></code>表示忽略当前shell进程PID，大多数时候它会继承父shell的pid，但在脚本中时它代表的是脚本所在shell的pid</li>
<li><code class="docutils literal"><span class="pre">-o</span> <span class="pre">$PPID</span></code>表示忽略父shell进程PID</li>
<li><code class="docutils literal"><span class="pre">-o</span> <span class="pre">%PPID</span></code>表示忽略调用pidof命令的shell进程PID</li>
</ul>
<p>关于<code class="docutils literal"><span class="pre">pidof</span></code>命令我们在这里简单介绍下，示例脚本如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s1">&#39;pidof bash: &#39;</span><span class="sb">`</span>pidof bash<span class="sb">`</span>
<span class="nb">echo</span> <span class="s1">&#39;script shell pid: &#39;</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$$</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s1">&#39;script parent shell pid: &#39;</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$PPID</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s1">&#39;pidof -o $$ bash: &#39;</span><span class="sb">`</span>pidof -o <span class="nv">$$</span> bash<span class="sb">`</span>
<span class="nb">echo</span> <span class="s1">&#39;pidof -o $PPID bash: &#39;</span><span class="sb">`</span>pidof -o <span class="nv">$PPID</span> bash<span class="sb">`</span>
<span class="nb">echo</span> <span class="s1">&#39;pidof -o %PPID bash: &#39;</span><span class="sb">`</span>pidof -o %PPID bash<span class="sb">`</span>
<span class="nb">echo</span> <span class="s1">&#39;pidof -o $$ -o $PPID -o %PPID bash: &#39;</span><span class="sb">`</span>pidof -o <span class="nv">$$</span> -o <span class="nv">$PPID</span> -o %PPID bash<span class="sb">`</span>
</pre></div>
</div>
<p>效果如下</p>
<div class="figure">
<img alt="../../../../_images/93.png" src="../../../../_images/93.png" />
</div>
<p>上述效果图中</p>
<ul>
<li><p class="first">第一个<code class="docutils literal"><span class="pre">pidof命令</span></code>显示结果中说明当前已有3个bash，pid分别为<code class="docutils literal"><span class="pre">3306、2436、2302</span></code></p>
</li>
<li><p class="first">第二个命令显示结果中</p>
<blockquote>
<div><ul class="simple">
<li>行1说明括号的父shell为6942</li>
<li>行5说明脚本的父shell为7337。即括号的父shell为当前bash环境，脚本的父shell为括号所在shell</li>
<li>行2减第一个命令的结果说明括号所在子shell的pid为7337</li>
<li>行3减行2说明shell脚本所在子shell的pid为7340</li>
<li><code class="docutils literal"><span class="pre">-o</span> <span class="pre">$$</span></code>忽略的是当前shell，即脚本所在shell的pid，因为在shell脚本中时，$$不继承父shell的pid</li>
<li><code class="docutils literal"><span class="pre">-o</span> <span class="pre">$PPID</span></code>忽略的是pidof所在父shell，即括号所在shell</li>
<li><code class="docutils literal"><span class="pre">-o</span> <span class="pre">%PPID</span></code>忽略的是调用pidof程序所在的shell，即脚本所在shell</li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="x0103-pidfileofproc">
<span id="pidproc"></span><h2>0x0103 pidfileofproc<a class="headerlink" href="#x0103-pidfileofproc" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">pidfileofproc</span></code>函数用来获取给定程序的<code class="docutils literal"><span class="pre">pid</span></code>，注意该函数不是获取<code class="docutils literal"><span class="pre">pidfile</span></code>，而是获取<code class="docutils literal"><span class="pre">pid值</span></code></p>
<p>以下是函数<code class="docutils literal"><span class="pre">pidfileofproc</span></code>的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># A function to find the pid of a program. Looks *only* at the pidfile</span>
pidfileofproc<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> pid

    <span class="c1"># Test syntax.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">$&quot;Usage: pidfileofproc {program}&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>

    __pids_var_run <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>         <span class="c1"># 不提供pidfile，因此认为是/var/run/$base.pid</span>
    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$pid</span>
    <span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>
</pre></div>
</div>
<p>由以上代码可知：<code class="docutils literal"><span class="pre">pidfileofproc</span></code>函数只能获取<code class="docutils literal"><span class="pre">/var/run</span></code>下的<code class="docutils literal"><span class="pre">pid值</span></code></p>
<p>该函数用的比较少，但确实有使用它的脚本；如<code class="docutils literal"><span class="pre">crond</span></code>启动脚本中借助<code class="docutils literal"><span class="pre">pidfileofproc</span></code>来杀进程</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">echo</span> -n $<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;`pidfileofproc </span><span class="nv">$exec</span><span class="s2">`&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        killproc <span class="nv">$exec</span>
        <span class="nv">RETVAL</span><span class="o">=</span><span class="m">3</span>
<span class="k">else</span>
        failure $<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2">&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="x0104-pidofproc">
<span id="pidprocll"></span><h2>0x0104 pidofproc<a class="headerlink" href="#x0104-pidofproc" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">pidofproc</span></code>函数也可以用来获取给定程序的<code class="docutils literal"><span class="pre">pid</span></code>，注意该函数不是获取<code class="docutils literal"><span class="pre">pidfile</span></code>，而是获取<code class="docutils literal"><span class="pre">pid值</span></code></p>
<p>以下是函数<code class="docutils literal"><span class="pre">pidofproc</span></code>的定义语句</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># A function to find the pid of a program.</span>
pidofproc<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> RC pid <span class="nv">pid_file</span><span class="o">=</span>

    <span class="c1"># Test syntax.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">$&quot;Usage: pidofproc [-p pidfile] {program}&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-p&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>    <span class="c1"># 既可以获取/var/run/$base.pid中的pid</span>
        <span class="nv">pid_file</span><span class="o">=</span><span class="nv">$2</span>             <span class="c1"># 也可以获取自给定pid文件中的pid</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="nv">fail_code</span><span class="o">=</span><span class="m">3</span> <span class="c1"># &quot;Program is not running&quot;</span>

    <span class="c1"># First try &quot;/var/run/*.pid&quot; files</span>
    __pids_var_run <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span>
    <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>      <span class="c1"># $pid不为空时，输出program的pid值</span>
        <span class="nb">echo</span> <span class="nv">$pid</span>
        <span class="k">return</span> <span class="m">0</span>
    <span class="k">fi</span>

    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="nv">$RC</span>  <span class="c1">#  $pid为空，但使用了&quot;-p&quot;指定pidfile时，返回$RC</span>
    __pids_pidof <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="k">return</span> <span class="nv">$RC</span>   <span class="c1">#  $pid为空，且$pidfile为空时，获取进程号pid并输出</span>
<span class="o">}</span>
</pre></div>
</div>
<p>由以上代码可知：<code class="docutils literal"><span class="pre">pidofproc</span></code>函数既可以获取<code class="docutils literal"><span class="pre">/var/run</span></code>下的<code class="docutils literal"><span class="pre">pid值</span></code>，又可以获取自给定<code class="docutils literal"><span class="pre">pidfile</span></code>中的<code class="docutils literal"><span class="pre">pid值</span></code></p>
<p>该函数用的比较少，但确实有使用它的脚本；如<code class="docutils literal"><span class="pre">dnsbind</span></code>的<code class="docutils literal"><span class="pre">named</span></code>服务启动脚本中借助<code class="docutils literal"><span class="pre">pidofproc</span></code>来判断进程是否已在运行</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>pidofnamed<span class="o">()</span> <span class="o">{</span>
        pidofproc -p <span class="s2">&quot;</span><span class="nv">$ROOTDIR$PIDFILE</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$named</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;`pidofnamed`&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -n <span class="s2">$&quot;named: already running&quot;</span>
        success
        <span class="nb">echo</span>
        <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="x0105-daemon">
<span id="daemonl"></span><h2>0x0105 daemon<a class="headerlink" href="#x0105-daemon" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">daemon</span></code>函数用于启动一个程序，并根据结果输出<code class="docutils literal"><span class="pre">success</span></code>或<code class="docutils literal"><span class="pre">failure</span></code></p>
<p><code class="docutils literal"><span class="pre">daemon</span></code>函数的定义语句如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># A function to start a program.</span>
daemon<span class="o">()</span> <span class="o">{</span>
    <span class="c1"># Test syntax.</span>
    <span class="nb">local</span> <span class="nv">gotbase</span><span class="o">=</span> <span class="nv">force</span><span class="o">=</span> nicelevel corelimit
    <span class="nb">local</span> pid <span class="nv">base</span><span class="o">=</span> <span class="nv">user</span><span class="o">=</span> <span class="nv">nice</span><span class="o">=</span> <span class="nv">bg</span><span class="o">=</span> <span class="nv">pid_file</span><span class="o">=</span>
    <span class="nb">local</span> <span class="nv">cgroup</span><span class="o">=</span>
    <span class="nv">nicelevel</span><span class="o">=</span><span class="m">0</span>
    <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">##[-+]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
        <span class="k">case</span> <span class="nv">$1</span> in
        <span class="s1">&#39;&#39;</span><span class="o">)</span>
            <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">: Usage: daemon [+/-nicelevel] {program}&quot;</span> <span class="s2">&quot;[arg1]...&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
            <span class="p">;;</span>
        --check<span class="o">)</span>
            <span class="nv">base</span><span class="o">=</span><span class="nv">$2</span>
            <span class="nv">gotbase</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
            <span class="nb">shift</span> <span class="m">2</span>
            <span class="p">;;</span>
        --check<span class="o">=</span>?*<span class="o">)</span>
            <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">#--check=</span><span class="si">}</span>
            <span class="nv">gotbase</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        --user<span class="o">)</span>
            <span class="nv">user</span><span class="o">=</span><span class="nv">$2</span>
            <span class="nb">shift</span> <span class="m">2</span>
            <span class="p">;;</span>
        --user<span class="o">=</span>?*<span class="o">)</span>
            <span class="nv">user</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">#--user=</span><span class="si">}</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        --pidfile<span class="o">)</span>
            <span class="nv">pid_file</span><span class="o">=</span><span class="nv">$2</span>
            <span class="nb">shift</span> <span class="m">2</span>
            <span class="p">;;</span>
        --pidfile<span class="o">=</span>?*<span class="o">)</span>
            <span class="nv">pid_file</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">#--pidfile=</span><span class="si">}</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        --force<span class="o">)</span>
            <span class="nv">force</span><span class="o">=</span><span class="s2">&quot;force&quot;</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        <span class="o">[</span>-+<span class="o">][</span><span class="m">0</span>-9<span class="o">]</span>*<span class="o">)</span>
            <span class="nv">nice</span><span class="o">=</span><span class="s2">&quot;nice -n </span><span class="nv">$1</span><span class="s2">&quot;</span>
            <span class="nb">shift</span>
            <span class="p">;;</span>
        *<span class="o">)</span>
            <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">: Usage: daemon [+/-nicelevel] {program}&quot;</span> <span class="s2">&quot;[arg1]...&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
            <span class="p">;;</span>
      <span class="k">esac</span>
    <span class="k">done</span>

    <span class="c1"># Save basename.</span>
    <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$gotbase</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>

    <span class="c1"># See if it&#39;s already running. Look *only* at the pid file.</span>
    __pids_var_run <span class="s2">&quot;</span><span class="nv">$base</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span>

    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> -a -z <span class="s2">&quot;</span><span class="nv">$force</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>

    <span class="c1"># make sure it doesn&#39;t core dump anywhere unless requested</span>
    <span class="nv">corelimit</span><span class="o">=</span><span class="s2">&quot;ulimit -S -c </span><span class="si">${</span><span class="nv">DAEMON_COREFILE_LIMIT</span><span class="k">:-</span><span class="nv">0</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># if they set NICELEVEL in /etc/sysconfig/foo, honor it</span>
    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">NICELEVEL</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">nice</span><span class="o">=</span><span class="s2">&quot;nice -n </span><span class="nv">$NICELEVEL</span><span class="s2">&quot;</span>

    <span class="c1"># if they set CGROUP_DAEMON in /etc/sysconfig/foo, honor it</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CGROUP_DAEMON</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> ! -x /bin/cgexec <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> -n <span class="s2">&quot;Cgroups not installed&quot;</span><span class="p">;</span> warning
            <span class="nb">echo</span>
        <span class="k">else</span>
            <span class="nv">cgroup</span><span class="o">=</span><span class="s2">&quot;/bin/cgexec&quot;</span><span class="p">;</span>
            <span class="k">for</span> i in <span class="nv">$CGROUP_DAEMON</span><span class="p">;</span> <span class="k">do</span>
                <span class="nv">cgroup</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$cgroup</span><span class="s2"> -g </span><span class="nv">$i</span><span class="s2">&quot;</span><span class="p">;</span>
            <span class="k">done</span>
        <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="c1"># Echo daemon</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BOOTUP</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -n <span class="s2">&quot; </span><span class="nv">$base</span><span class="s2">&quot;</span>

    <span class="c1"># And start it up.</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$user</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       <span class="nv">$cgroup</span> <span class="nv">$nice</span> /bin/bash -c <span class="s2">&quot;</span><span class="nv">$corelimit</span><span class="s2"> &gt;/dev/null 2&gt;&amp;1 ; </span><span class="nv">$*</span><span class="s2">&quot;</span>
    <span class="k">else</span>
       <span class="nv">$cgroup</span> <span class="nv">$nice</span> runuser -s /bin/bash <span class="nv">$user</span> -c <span class="s2">&quot;</span><span class="nv">$corelimit</span><span class="s2"> &gt;/dev/null 2&gt;&amp;1 ; </span><span class="nv">$*</span><span class="s2">&quot;</span>
    <span class="k">fi</span>

    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> startup&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> startup&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>daemon函数调用方法</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>daemon <span class="o">[</span>--check<span class="o">=</span>servicename<span class="o">]</span> <span class="o">[</span>--user<span class="o">=</span>USER<span class="o">]</span> <span class="o">[</span>--pidfile<span class="o">=</span>PIDFILE<span class="o">]</span> <span class="o">[</span>--force<span class="o">]</span> program <span class="o">[</span>prog_args<span class="o">]</span>
</pre></div>
</div>
<p>其中需要注意的是</p>
<ul class="simple">
<li>只有<code class="docutils literal"><span class="pre">--user</span></code>选项可以用来控制<code class="docutils literal"><span class="pre">program</span></code>启动的环境</li>
<li><code class="docutils literal"><span class="pre">--check</span></code>和<code class="docutils literal"><span class="pre">--pidfile</span></code>选项都是用来检查是否已运行的，不是用来启动的，如果提供了<code class="docutils literal"><span class="pre">--check</span></code>，则检查的是名为<code class="docutils literal"><span class="pre">`servicename</span></code>的进程，否则检查的是<code class="docutils literal"><span class="pre">program</span></code>名称的进程</li>
<li><code class="docutils literal"><span class="pre">--force</span></code>则表示进程已存在时仍启动</li>
<li><code class="docutils literal"><span class="pre">prog_args</span></code>是向<code class="docutils literal"><span class="pre">program</span></code>传递它的运行参数，一般会从<code class="docutils literal"><span class="pre">/etc/sysconfig/$base</span></code>文件中获取</li>
</ul>
<p>例如httpd的启动脚本中</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">echo</span> -n $<span class="s2">&quot;Starting </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
daemon --pidfile<span class="o">=</span><span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span> <span class="nv">$httpd</span> <span class="nv">$OPTIONS</span>
</pre></div>
</div>
<p>其执行结果大致如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="o">[</span>root@xuexi ~<span class="o">]</span><span class="c1"># service httpd start</span>
Starting httpd:                            <span class="o">[</span>  OK  <span class="o">]</span>
</pre></div>
</div>
<p>还需注意，通常<code class="docutils literal"><span class="pre">program</span></code>的运行参数可能也是<code class="docutils literal"><span class="pre">--</span></code>开头的，要和<code class="docutils literal"><span class="pre">program</span></code>前面的选项区分。例如</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>daemon --pidfile <span class="nv">$pidfile</span> --check <span class="nv">$servicename</span> <span class="nv">$processname</span> --pid-file<span class="o">=</span><span class="nv">$pidfile</span>
</pre></div>
</div>
<p>其中</p>
<ul class="simple">
<li>第二个<code class="docutils literal"><span class="pre">--pid-file</span></code>是<code class="docutils literal"><span class="pre">$processname</span></code>的运行参数</li>
<li>第一个<code class="docutils literal"><span class="pre">--pidfile</span></code>是daemon检测<code class="docutils literal"><span class="pre">$processname</span></code>是否已运行的选项</li>
<li>由于提供了<code class="docutils literal"><span class="pre">--check</span> <span class="pre">$servicename</span></code>，所以函数调用语句<code class="docutils literal"><span class="pre">__pids_var_run</span> <span class="pre">$base</span> <span class="pre">[pidfile]</span></code>中的<code class="docutils literal"><span class="pre">$base</span></code>等于<code class="docutils literal"><span class="pre">$servicename</span></code>，即表示检查<code class="docutils literal"><span class="pre">$servicename</span></code>进程是否允许；如果没有提供该选项，则检查的是<code class="docutils literal"><span class="pre">$processname</span></code></li>
</ul>
<p>在<code class="docutils literal"><span class="pre">SysV</span></code>脚本中，<code class="docutils literal"><span class="pre">daemon</span></code>会配合以下几个语句同时执行</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">echo</span> -n $<span class="s2">&quot;Starting </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
daemon --pidfile<span class="o">=</span><span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span> <span class="nv">$prog</span> <span class="nv">$OPTIONS</span>
<span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
<span class="o">[</span> <span class="nv">$RETVAL</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> touch <span class="si">${</span><span class="nv">lockfile</span><span class="si">}</span>
<span class="k">return</span> <span class="nv">$RETVAL</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">daemon</span></code>函数启动程序时，自身就会调用<code class="docutils literal"><span class="pre">success</span></code>或<code class="docutils literal"><span class="pre">failure</span></code>函数，所以就不需再使用<code class="docutils literal"><span class="pre">action</span></code>函数了；如果不使用<code class="docutils literal"><span class="pre">daemon</span></code>函数启动服务，通常会配合<code class="docutils literal"><span class="pre">action</span></code>函数，例如：</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nv">$prog</span> <span class="nv">$OPTIONS</span>
<span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
<span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> action <span class="s2">&quot;Starting </span><span class="nv">$prog</span><span class="s2">&quot;</span> /bin/true <span class="o">&amp;&amp;</span> touch <span class="si">${</span><span class="nv">lockfile</span><span class="si">}</span>
</pre></div>
</div>
</div>
<div class="section" id="x0106-killproc">
<span id="killprocl"></span><h2>0x0106 killproc<a class="headerlink" href="#x0106-killproc" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">killproc</span></code>函数的作用是根据给定程序名杀进程；中间它会获取程序名对应的<code class="docutils literal"><span class="pre">pid号</span></code>，且保证<code class="docutils literal"><span class="pre">/proc</span></code>目录下没有<code class="docutils literal"><span class="pre">pid</span></code>对应的目录才表示进程关闭成功</p>
<p><code class="docutils literal"><span class="pre">killproc</span></code>函数的定义语句如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># A function to stop a program.</span>
killproc<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> RC <span class="nv">killlevel</span><span class="o">=</span> base pid <span class="nv">pid_file</span><span class="o">=</span> delay try <span class="nv">binary</span><span class="o">=</span>

    <span class="nv">RC</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> <span class="nv">delay</span><span class="o">=</span><span class="m">3</span><span class="p">;</span> <span class="nv">try</span><span class="o">=</span><span class="m">0</span>
    <span class="c1"># Test syntax.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">$&quot;Usage: killproc [-p pidfile] [ -d delay] {program} [-signal]&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-p&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">pid_file</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-b&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="nv">$pid_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">$&quot;-b option can be used only with -p&quot;</span>
            <span class="nb">echo</span> <span class="s2">$&quot;Usage: killproc -p pidfile -b binary program&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
        <span class="k">fi</span>
        <span class="nv">binary</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-d&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">$&quot;Usage: killproc [-p pidfile] [ -d delay] {program} [-signal]&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
        <span class="k">fi</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>


    <span class="c1"># check for second arg to be kill level</span>
    <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">killlevel</span><span class="o">=</span><span class="nv">$2</span>

    <span class="c1"># Save basename.</span>
    <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>

    <span class="c1"># Find pid.</span>
    __pids_var_run <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$binary</span><span class="s2">&quot;</span>
    <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nv">pid</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>__pids_pidof <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
        <span class="k">else</span>
            <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span> <span class="p">;</span> <span class="k">return</span> <span class="nv">$RC</span> <span class="p">;</span><span class="o">}</span>
        <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="c1"># Kill it.</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$BOOTUP</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;verbose&quot;</span> -a -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> &quot;</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
            __kill_pids_term_kill -d <span class="nv">$delay</span> <span class="nv">$pid</span>
            <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
            <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span>
        <span class="c1"># use specified level only</span>
        <span class="k">else</span>
            <span class="k">if</span> checkpid <span class="nv">$pid</span><span class="p">;</span> <span class="k">then</span>
                <span class="nb">kill</span> <span class="nv">$killlevel</span> <span class="nv">$pid</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
                <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
                <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> </span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> </span><span class="nv">$killlevel</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nv">RC</span><span class="o">=</span><span class="m">7</span> <span class="c1"># Program is not running</span>
            <span class="k">fi</span>
        <span class="k">fi</span>
    <span class="k">else</span>
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> -a -n <span class="s2">&quot;</span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nv">RC</span><span class="o">=</span><span class="m">7</span> <span class="c1"># Program is not running</span>
        <span class="k">else</span>
            failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span>
            <span class="nv">RC</span><span class="o">=</span><span class="m">0</span>
            __kill_pids_term_kill -d <span class="nv">$delay</span> <span class="nv">$pid</span>
            <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
            <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span>
        <span class="c1"># use specified level only</span>
        <span class="k">else</span>
            <span class="k">if</span> checkpid <span class="nv">$pid</span><span class="p">;</span> <span class="k">then</span>
                <span class="nb">kill</span> <span class="nv">$killlevel</span> <span class="nv">$pid</span> &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
                <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
                <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> success $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> </span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">||</span> failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> </span><span class="nv">$killlevel</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nv">RC</span><span class="o">=</span><span class="m">7</span> <span class="c1"># Program is not running</span>
            <span class="k">fi</span>
        <span class="k">fi</span>
    <span class="k">else</span>
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LSB</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> -a -n <span class="s2">&quot;</span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nv">RC</span><span class="o">=</span><span class="m">7</span> <span class="c1"># Program is not running</span>
        <span class="k">else</span>
            failure $<span class="s2">&quot;</span><span class="nv">$base</span><span class="s2"> shutdown&quot;</span>
            <span class="nv">RC</span><span class="o">=</span><span class="m">0</span>
        <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="c1"># Remove pid file if any.</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$killlevel</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        rm -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">pid_file</span><span class="k">:-</span><span class="p">/var/run/</span><span class="nv">$base</span><span class="p">.pid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
    <span class="k">return</span> <span class="nv">$RC</span>
<span class="o">}</span>
</pre></div>
</div>
<p>由上述代码可知：关闭进程时，需要再三确定<code class="docutils literal"><span class="pre">pid文件</span></code>是否存在，<code class="docutils literal"><span class="pre">/proc</span></code>下是否有和<code class="docutils literal"><span class="pre">pid</span></code>对应的目录。直到<code class="docutils literal"><span class="pre">/proc</span></code>下已经没有了和<code class="docutils literal"><span class="pre">pid</span></code>对应的目录时，才表示进程真正杀死了；但此时<code class="docutils literal"><span class="pre">pid文件</span></code>仍可能存在，因此还要保证<code class="docutils literal"><span class="pre">pid文件</span></code>已被移除</p>
<p>该函数的调用方法如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>killproc <span class="o">[</span>-p pidfile<span class="o">]</span> <span class="o">[</span> -d delay<span class="o">]</span> <span class="o">{</span>program<span class="o">}</span> <span class="o">[</span>-signal<span class="o">]</span>
</pre></div>
</div>
<p>其中</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">-p</span> <span class="pre">pidfile</span></code>：用于指定从此文件中获取进程的<code class="docutils literal"><span class="pre">pid号</span></code>，不指定时默认从<code class="docutils literal"><span class="pre">/var/run/$base.pid</span></code>中获取</li>
<li><code class="docutils literal"><span class="pre">-d</span> <span class="pre">delay</span></code>：指定未使用<code class="docutils literal"><span class="pre">-signal</span></code>时的延迟检测时间；有效单位为<code class="docutils literal"><span class="pre">秒、分、时、日(&quot;smhd&quot;)</span></code>，不写时默认为秒</li>
<li><code class="docutils literal"><span class="pre">-signal</span></code>：用于指定<code class="docutils literal"><span class="pre">kill</span></code>发送的信号；如果不指定，则默认先发送<code class="docutils literal"><span class="pre">TERM</span></code>信号，在<code class="docutils literal"><span class="pre">-d</span> <span class="pre">delay</span></code>时间段内仍不断检测是否进程已经被杀死，如果还未死透，则<code class="docutils literal"><span class="pre">delay</span></code>超时后发送<code class="docutils literal"><span class="pre">KILL</span></code>信号强制杀死</li>
</ul>
<p>需要明确的是，只有<code class="docutils literal"><span class="pre">/proc</span></code>目录下没有了<code class="docutils literal"><span class="pre">pid</span></code>对应的目录才算是杀死了；
一般来说，<code class="docutils literal"><span class="pre">killproc</span></code>前会判断进程是否已在运行，最后还要删除<code class="docutils literal"><span class="pre">pid文件</span></code>和<code class="docutils literal"><span class="pre">lock文件</span></code>；当然，<code class="docutils literal"><span class="pre">killproc</span></code>函数可以保证<code class="docutils literal"><span class="pre">pid文件</span></code>被删除；所以，<code class="docutils literal"><span class="pre">killproc</span></code>函数大致会同时配合以下语句用来杀进程</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>status -p <span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span> <span class="nv">$prog</span> &gt; /dev/null
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> -n $<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
        killproc -p <span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span> -d <span class="si">${</span><span class="nv">STOP_TIMEOUT</span><span class="si">}</span> <span class="nv">$httpd</span>
<span class="k">else</span>
        <span class="nb">echo</span> -n $<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2">: &quot;</span>
        success
<span class="k">fi</span>
<span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
<span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="si">${</span><span class="nv">lockfile</span><span class="si">}</span> <span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span>
</pre></div>
</div>
<p>同样注意，<code class="docutils literal"><span class="pre">killproc</span></code>中已经自带<code class="docutils literal"><span class="pre">success</span></code>和<code class="docutils literal"><span class="pre">failure</span></code>函数；如果不使用<code class="docutils literal"><span class="pre">killproc</span></code>杀进程，则通常会配合<code class="docutils literal"><span class="pre">action</span></code>函数或者<code class="docutils literal"><span class="pre">success</span></code>、``failure``；大致如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>killall <span class="nv">$prog</span> ； usleep <span class="m">50000</span> ； killall <span class="nv">$prog</span>
<span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;RETVAL&quot;</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    action $<span class="s2">&quot;Stopping </span><span class="nv">$prog</span><span class="s2">: &quot;</span> /bin/true
    rm -rf <span class="si">${</span><span class="nv">lockfile</span><span class="si">}</span> <span class="si">${</span><span class="nv">pidfile</span><span class="si">}</span>
<span class="k">else</span>
    action $<span class="s2">&quot;Stoping </span><span class="nv">$prog</span><span class="s2">: &quot;</span> /bin/false
<span class="k">fi</span>
</pre></div>
</div>
<p>以上由于采用的是<code class="docutils literal"><span class="pre">killall</span></code>命令，如果采用的是<code class="docutils literal"><span class="pre">kill</span></code>命令，则需要先获取进程的<code class="docutils literal"><span class="pre">pid</span></code>，在此之前还要检查<code class="docutils literal"><span class="pre">pid文件</span></code>是否存在</p>
</div>
<div class="section" id="x0107-status">
<span id="statusl"></span><h2>0x0107 status<a class="headerlink" href="#x0107-status" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">status</span></code>函数用于获取进程的运行状态，有以下几种状态</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">${base}</span> <span class="pre">(pid</span> <span class="pre">$pid)</span> <span class="pre">is</span> <span class="pre">running...</span></code></li>
<li><code class="docutils literal"><span class="pre">${base}</span> <span class="pre">dead</span> <span class="pre">but</span> <span class="pre">pid</span> <span class="pre">file</span> <span class="pre">exists</span></code></li>
<li><code class="docutils literal"><span class="pre">${base}</span> <span class="pre">status</span> <span class="pre">unknown</span> <span class="pre">due</span> <span class="pre">to</span> <span class="pre">insufficient</span> <span class="pre">privileges</span></code></li>
<li><code class="docutils literal"><span class="pre">${base}</span> <span class="pre">dead</span> <span class="pre">but</span> <span class="pre">subsys</span> <span class="pre">locked</span></code></li>
<li><code class="docutils literal"><span class="pre">${base}</span> <span class="pre">is</span> <span class="pre">stopped</span></code></li>
</ul>
<p><code class="docutils literal"><span class="pre">status</span></code>函数定义语句如下(注意：此为<code class="docutils literal"><span class="pre">CentOS</span> <span class="pre">7</span></code>上语句，比<code class="docutils literal"><span class="pre">CentOS</span> <span class="pre">6</span></code>多了一段<code class="docutils literal"><span class="pre">systemctl</span></code>的处理，用于<code class="docutils literal"><span class="pre">Sysv</span></code>的<code class="docutils literal"><span class="pre">status</span></code>状态向<code class="docutils literal"><span class="pre">systemd</span></code>的<code class="docutils literal"><span class="pre">status</span></code>状态转换)</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>status<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> base pid <span class="nv">lock_file</span><span class="o">=</span> <span class="nv">pid_file</span><span class="o">=</span> <span class="nv">binary</span><span class="o">=</span>

    <span class="c1"># Test syntax.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">$&quot;Usage: status [-p pidfile] {program}&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-p&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">pid_file</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-l&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">lock_file</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-b&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="nv">$pid_file</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">$&quot;-b option can be used only with -p&quot;</span>
            <span class="nb">echo</span> <span class="s2">$&quot;Usage: status -p pidfile -b binary program&quot;</span>
            <span class="k">return</span> <span class="m">1</span>
        <span class="k">fi</span>
        <span class="nv">binary</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">shift</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="nv">base</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">##*/</span><span class="si">}</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$_use_systemctl</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        systemctl status <span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span>.service
        <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>
        <span class="c1"># LSB daemons that dies abnormally in systemd looks alive in systemd&#39;s eyes due to RemainAfterExit=yes</span>
        <span class="c1"># lets adjust the reality a little bit</span>
        <span class="k">if</span> systemctl show -p ActiveState <span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span>.service <span class="p">|</span> grep -q <span class="s1">&#39;=active$&#39;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
        systemctl show -p SubState <span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span>.service <span class="p">|</span> grep -q <span class="s1">&#39;=exited$&#39;</span> <span class="p">;</span> <span class="k">then</span>
            <span class="nv">ret</span><span class="o">=</span><span class="m">3</span>
        <span class="k">fi</span>
        <span class="k">return</span> <span class="nv">$ret</span>
    <span class="k">fi</span>

    <span class="c1"># First try &quot;pidof&quot;</span>
    __pids_var_run <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$binary</span><span class="s2">&quot;</span>
    <span class="nv">RC</span><span class="o">=</span><span class="nv">$?</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$pid_file</span><span class="s2">&quot;</span> -a -z <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">pid</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>__pids_pidof <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$pid</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> (pid </span><span class="nv">$pid</span><span class="s2">) is running...&quot;</span>
        <span class="k">return</span> <span class="m">0</span>
    <span class="k">fi</span>

    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$RC</span><span class="s2">&quot;</span> in
    <span class="m">0</span><span class="o">)</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> (pid </span><span class="nv">$pid</span><span class="s2">) is running...&quot;</span>
        <span class="k">return</span> <span class="m">0</span>
        <span class="p">;;</span>
    <span class="m">1</span><span class="o">)</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> dead but pid file exists&quot;</span>
        <span class="k">return</span> <span class="m">1</span>
        <span class="p">;;</span>
    <span class="m">4</span><span class="o">)</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> status unknown due to insufficient privileges.&quot;</span>
        <span class="k">return</span> <span class="m">4</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">lock_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">lock_file</span><span class="o">=</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span>
    <span class="k">fi</span>
    <span class="c1"># See if /var/lock/subsys/${lock_file} exists</span>
    <span class="k">if</span> <span class="o">[</span> -f /var/lock/subsys/<span class="si">${</span><span class="nv">lock_file</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> dead but subsys locked&quot;</span>
        <span class="k">return</span> <span class="m">2</span>
    <span class="k">fi</span>
    <span class="nb">echo</span> $<span class="s2">&quot;</span><span class="si">${</span><span class="nv">base</span><span class="si">}</span><span class="s2"> is stopped&quot;</span>
    <span class="k">return</span> <span class="m">3</span>
<span class="o">}</span>
</pre></div>
</div>
<p>该函数的调用方法如下</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>status <span class="o">[</span>-p pidfile<span class="o">]</span> <span class="o">[</span>-l lockfile<span class="o">]</span> program
<span class="c1"># 如果同时提供了-p和-l选项，-l选项必须放在-p选项后面</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../3-sample/index.html" class="btn btn-neutral float-right" title="脚本示例" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../1-commoncmd/index.html" class="btn btn-neutral" title="常用命令" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, HappyAnony.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>